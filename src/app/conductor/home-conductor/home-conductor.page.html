<ion-menu side="start" menuId="conductor-menu" contentId="home-conductor-content">
  <ion-header>
    <ion-toolbar color="success">
      <ion-title>{{userName}}</ion-title>
    </ion-toolbar>
  </ion-header>
  <ion-content>
    <ion-list>
      <ion-menu-toggle auto-hide="false">
        <ion-item (click)="logout()">
          <ion-icon slot="start" name="log-out"></ion-icon>
          <ion-label>Cerrar sesi贸n</ion-label>
        </ion-item>
      </ion-menu-toggle>
    </ion-list>
  </ion-content>
</ion-menu>

<ion-header [translucent]="true" class="header-custom">
  <ion-toolbar color="success" class="toolbar-gradient">
    <!-- Bot贸n del men煤 corregido -->
    <ion-buttons slot="start">
      <ion-menu-button menu="conductor-menu" class="menu-button">
        <ion-icon name="menu" color="light"></ion-icon>
      </ion-menu-button>
    </ion-buttons>
    
    <ion-title class="title-custom">
      <ion-icon name="navigate" class="title-icon"></ion-icon>
      Recorrido de Rutas
    </ion-title>
    
    <ion-buttons slot="end">
      <ion-button>
        <ion-icon name="notifications" color="light"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content id="home-conductor-content" [fullscreen]="true" class="content-custom">
  <!-- Mapa en la parte superior -->
  <div class="mapa-container">
    <div id="mapId" class="mapa"></div>
  </div>

  <!-- Selector de Modo de Operaci贸n -->
  <div class="section mode-section">
    <div class="mode-selector">
      <ion-segment [value]="modoOperacion" (ionChange)="cambiarModoOperacion($event)">
        <ion-segment-button value="tiempo-real">
          <ion-icon name="radio"></ion-icon>
          <ion-label>Tiempo Real</ion-label>
        </ion-segment-button>
        <ion-segment-button value="simulacion">
          <ion-icon name="play"></ion-icon>
          <ion-label>Simulaci贸n</ion-label>
        </ion-segment-button>
      </ion-segment>
    </div>
    
    <div class="mode-info" *ngIf="modoRecorrido">
      <ion-badge [color]="modoOperacion === 'tiempo-real' ? 'success' : 'warning'">
        <ion-icon [name]="modoOperacion === 'tiempo-real' ? 'radio' : 'play'"></ion-icon>
        {{ modoOperacion === 'tiempo-real' ? 'TIEMPO REAL' : 'SIMULACIN' }}
      </ion-badge>
      <span class="time-remaining" *ngIf="pruebaActiva">
      </span>
    </div>

    <div class="mode-description">
      <small>
        <ion-icon [name]="modoOperacion === 'tiempo-real' ? 'radio' : 'play'" 
                  [color]="modoOperacion === 'tiempo-real' ? 'success' : 'warning'"></ion-icon>
        {{ modoOperacion === 'tiempo-real' ? 
           'Usa tu ubicaci贸n GPS real para el seguimiento en tiempo real' : 
           'Movimiento autom谩tico para pruebas y demostraciones' }}
      </small>
    </div>
  </div>

  <!-- Selectores debajo del mapa -->
  <div class="section selectores-section">
    <div class="selectors-grid">
      <!-- Selector de Ruta -->
      <div class="selector-card route-selector">
        <div class="selector-content">
          <label class="selector-label">Selecciona una Ruta</label>
          <ion-select 
            placeholder="Elige tu ruta..." 
            (ionChange)="seleccionarRuta($event)" 
            interface="popover"
            class="custom-select">
            <ion-select-option *ngFor="let ruta of rutasGuardadas" [value]="ruta.id">
              {{ ruta.nombre_ruta }}
            </ion-select-option>
          </ion-select>
        </div>

        <!-- Selector de Veh铆culo -->
        <div class="selector-content">
          <label class="selector-label">Selecciona un Veh铆culo</label>
          <ion-select 
            (ionChange)="seleccionarVehiculo($event)" 
            placeholder="Elige tu veh铆culo..." 
            interface="popover"
            class="custom-select">
            <ion-select-option *ngFor="let vehiculo of vehiculo" [value]="vehiculo.id">
              {{ vehiculo.marca }} - {{ vehiculo.placa }}
            </ion-select-option>
          </ion-select>
        </div>
      </div>
    </div>
  </div>

  <!-- Informaci贸n del Recorrido Actual -->
  <div class="section info-section" *ngIf="rutaSeleccionada">
    <div class="info-card">
      <div class="info-header">
        <div class="route-badge">
          <ion-icon name="map"></ion-icon>
          <span>Ruta Activa</span>
        </div>
        <div class="vehicle-badge" *ngIf="vehiculoSeleccionado">
          <ion-icon name="car-sport"></ion-icon>
          <span>{{ vehiculoSeleccionado.placa }}</span>
        </div>
        <div class="mode-badge" *ngIf="modoRecorrido">
          <ion-badge [color]="modoOperacion === 'tiempo-real' ? 'success' : 'warning'">
            {{ modoOperacion === 'tiempo-real' ? ' REAL' : ' SIM' }}
          </ion-badge>
        </div>
      </div>

      <div class="route-details">
        <h3 class="route-name">{{ rutaSeleccionada.nombre_ruta }}</h3>
        <p class="route-description">Recorrido programado con {{ puntosRutaActual?.length || 0 }} puntos de parada</p>
        
        <!-- Informaci贸n de progreso mejorada -->
        <div class="progress-details" *ngIf="modoRecorrido">
          <div class="progress-item">
            <ion-icon name="speedometer" color="primary"></ion-icon>
            <span>Progreso: {{ progresoRuta.toFixed(1) }}%</span>
          </div>
          <div class="progress-item">
            <ion-icon name="location" color="success"></ion-icon>
          </div>
        </div>
      </div>

      <!-- Progress Bar -->
      <div class="progress-container" *ngIf="modoRecorrido">
        <div class="progress-info">
          <span class="progress-text">Progreso del Recorrido</span>
          <span class="progress-percentage">{{ progresoRuta.toFixed(1) }}%</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="progresoRuta"></div>
        </div>
        <div class="progress-stats">
          <small>
            <span *ngIf="modoOperacion === 'simulacion'">
              Punto {{ indicePuntoActual + 1 }} de {{ puntosRutaActual.length }}
            </span>
            <span *ngIf="modoOperacion === 'tiempo-real'">
            </span>
            <span *ngIf="pruebaActiva" class="time-remaining">
            </span>
          </small>
        </div>
      </div>
    </div>
  </div>

  <!-- Control Principal -->
  <div class="section control-section">
    <div class="action-container">
      <ion-button 
        class="main-action-button" 
        [color]="modoRecorrido ? 'danger' : 'success'" 
        (click)="toggleRecorridoMode()" 
        [disabled]="!rutaSeleccionada"
        expand="block"
        shape="round"
        size="large">
        <ion-icon 
          [name]="modoRecorrido ? 'stop-circle' : 'play-circle'" 
          slot="start"
          class="action-icon">
        </ion-icon>
        {{ modoRecorrido ? 'DETENER RECORRIDO' : 'INICIAR RECORRIDO' }}
        <ion-spinner *ngIf="modoRecorrido" name="crescent" slot="end"></ion-spinner>
      </ion-button>

      <div class="action-info" *ngIf="!rutaSeleccionada">
        <ion-icon name="information-circle" color="medium"></ion-icon>
        <span style="font-size: 13px;">Selecciona una ruta y veh铆culo para comenzar</span>
      </div>

      <div class="mode-warning" *ngIf="rutaSeleccionada && !modoRecorrido">
        <ion-icon 
          [name]="modoOperacion === 'tiempo-real' ? 'radio' : 'play'" 
          [color]="modoOperacion === 'tiempo-real' ? 'success' : 'warning'">
        </ion-icon>
        <span>
          Modo <strong>{{ modoOperacion === 'tiempo-real' ? 'Tiempo Real' : 'Simulaci贸n' }}</strong> listo
        </span>
      </div>
    </div>
  </div>

  <!-- Estado del Recorrido (Solo cuando est谩 activo) -->
  <div class="section status-section" *ngIf="modoRecorrido">
    <div class="status-card">
      <div class="status-header">
        <div class="status-indicator">
          <div class="pulse-dot" [class.real-time]="modoOperacion === 'tiempo-real'" 
                               [class.simulation]="modoOperacion === 'simulacion'"></div>
          <ion-icon [name]="modoOperacion === 'tiempo-real' ? 'radio' : 'play'" 
                   class="pulse-icon"></ion-icon>
          <span>Recorrido en Progreso - {{ modoOperacion === 'tiempo-real' ? 'TIEMPO REAL' : 'SIMULACIN' }}</span>
        </div>
        <div class="status-time" *ngIf="pruebaActiva">
          <ion-icon name="time"></ion-icon>
        </div>
      </div>

      <div class="status-grid">
        <div class="status-item">
          <div class="status-icon" [class.real-time]="modoOperacion === 'tiempo-real'" 
                                 [class.simulation]="modoOperacion === 'simulacion'">
            <ion-icon name="trail-sign"></ion-icon>
          </div>
          <div class="status-details">
            <label>Ruta Actual</label>
            <strong>{{ rutaSeleccionada?.nombre_ruta }}</strong>
          </div>
        </div>

        <div class="status-item">
          <div class="status-icon" [class.real-time]="modoOperacion === 'tiempo-real'" 
                                 [class.simulation]="modoOperacion === 'simulacion'">
            <ion-icon name="location"></ion-icon>
          </div>
          <div class="status-details">
            <label>Progreso</label>
            <strong>{{ progresoRuta.toFixed(1) }}%</strong>
          </div>
        </div>

        <div class="status-item">
          <div class="status-icon" [class.real-time]="modoOperacion === 'tiempo-real'" 
                                 [class.simulation]="modoOperacion === 'simulacion'">
            <ion-icon name="car-sport"></ion-icon>
          </div>
          <div class="status-details">
            <label>Veh铆culo</label>
            <strong>{{ vehiculoSeleccionado?.marca }} - {{ vehiculoSeleccionado?.placa }}</strong>
          </div>
        </div>

        <div class="status-item">
          <div class="status-icon" [class.real-time]="modoOperacion === 'tiempo-real'" 
                                 [class.simulation]="modoOperacion === 'simulacion'">
            <ion-icon name="speedometer"></ion-icon>
          </div>
          <div class="status-details">
            <label>Estado</label>
            <strong [class]="modoOperacion === 'tiempo-real' ? 'status-real-time' : 'status-simulation'">
              {{ modoOperacion === 'tiempo-real' ? 'En Movimiento Real' : 'Simulando' }}
            </strong>
          </div>
        </div>
      </div>

      <!-- Informaci贸n adicional seg煤n el modo -->
      <div class="mode-specific-info">
        <div *ngIf="modoOperacion === 'tiempo-real'" class="real-time-info">
          <ion-icon name="cellular" color="success"></ion-icon>
          <span>Enviando ubicaci贸n en tiempo real al servidor</span>
        </div>
        <div *ngIf="modoOperacion === 'simulacion'" class="simulation-info">
          <ion-icon name="play" color="warning"></ion-icon>
          <span>Simulando movimiento autom谩tico por la ruta</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Espacio final para mejor scroll -->
  <div class="scroll-spacer"></div>
</ion-content>